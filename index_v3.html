<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video e Mappa Sincronizzati</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      video { position: relative; display: inline-block; width: 40%; height: 500px; margin: 20px; }
      #map { position: relative; display: inline-block; width: 40%; height: 500px; margin: 20px; }
      #controls { position: relative; display: block; margin-top: 20px; width: 100%; }
      #playPauseButton { margin-right: 10px; }
      #chartContainer { width: 80%; margin: 20px auto; }
    </style>
</head>
<body>

<video id="video" width="600" controls preload="metadata">
    <source src="assets/video/drone.mp4" type="video/mp4">
    Your browser does not support the video tag.
</video>

<div id="map"></div>

<div id="controls">
    <button id="playPauseButton">Play</button>
    <input type="range" id="slider" min="0" max="100" value="0">
</div>

<div id="chartContainer">
    <canvas id="altitudeChart"></canvas>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Inizializza la mappa
var map = L.map('map').setView([51.505, -0.09], 13);

// Aggiungi il tile layer a OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

// Definisci il percorso con le altezze
var route = [
    { lat: 51.505, lng: -0.09, alt: 50 },
    { lat: 51.51, lng: -0.1, alt: 100 },
    { lat: 51.51, lng: -0.12, alt: 150 }
];
var latlngs = route.map(point => [point.lat, point.lng]);
var polyline = L.polyline(latlngs, { color: 'red' }).addTo(map);
var marker = L.marker(latlngs[0]).addTo(map);

// Sincronizza video, slider e marker
var video = document.getElementById('video');
var slider = document.getElementById('slider');
var playPauseButton = document.getElementById('playPauseButton');

// Crea il grafico con Chart.js
var ctx = document.getElementById('altitudeChart').getContext('2d');
var chartData = route.map(point => point.alt);
var data = {
    labels: chartData,
    datasets: [{
        label: 'Altitude (m)',
        data: chartData,
        fill: true,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        tension: 0.1
    }]
};
var config = {
    type: 'line',
    data: data,
    options: {
        responsive: true,
        plugins: {
            tooltip: {
                enabled: false,
                mode: 'index',
                intersect: false,
                external: customTooltip
            }
        },
        interaction: {
            intersect: false,
            mode: 'index'
        }
    }
};
var altitudeChart = new Chart(ctx, config);

function customTooltip(context) {
    // Tooltip customization
    let tooltipEl = document.getElementById('chartjs-tooltip');

    // Create element on first render
    if (!tooltipEl) {
        tooltipEl = document.createElement('div');
        tooltipEl.id = 'chartjs-tooltip';
        tooltipEl.style.opacity = 0;
        tooltipEl.style.position = 'absolute';
        tooltipEl.style.background = 'rgba(0, 0, 0, 0.7)';
        tooltipEl.style.borderRadius = '3px';
        tooltipEl.style.color = 'white';
        tooltipEl.style.pointerEvents = 'none';
        tooltipEl.style.transition = 'opacity 0.3s ease';

        const table = document.createElement('table');
        table.style.margin = '0px';
        tooltipEl.appendChild(table);
        document.body.appendChild(tooltipEl);
    }

    // Hide if no tooltip
    const tooltipModel = context.tooltip;
    if (tooltipModel.opacity === 0) {
        tooltipEl.style.opacity = 0;
        return;
    }

    // Set Text
    if (tooltipModel.body) {
        const bodyLines = tooltipModel.body.map(item => item.lines);
        let innerHtml = '<thead>';

        tooltipModel.title.forEach(title => {
            innerHtml += '<tr><th>' + title + '</th></tr>';
        });
        innerHtml += '</thead><tbody>';

        bodyLines.forEach(body => {
            innerHtml += '<tr><td>' + body + '</td></tr>';
        });
        innerHtml += '</tbody>';

        const tableRoot = tooltipEl.querySelector('table');
        tableRoot.innerHTML = innerHtml;
    }

    // Display, position, and set styles for font
    const position = context.chart.canvas.getBoundingClientRect();
    tooltipEl.style.opacity = 1;
    tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
    tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
    tooltipEl.style.fontFamily = tooltipModel.options.bodyFont.family;
    tooltipEl.style.fontSize = tooltipModel.options.bodyFont.size + 'px';
    tooltipEl.style.fontStyle = tooltipModel.options.bodyFont.style;
    tooltipEl.style.padding = tooltipModel.options.padding + 'px ' + tooltipModel.options.padding + 'px';
}

// Carica i metadati dal file JSON
fetch('assets/video/metadata.json')
    .then(response => response.json())
    .then(data => {
        console.log('Loaded metadata:', data);
        video.duration = data.drone.duration;
        slider.max = data.drone.duration;
    })
    .catch(error => console.error('Error loading metadata:', error));

// Aggiorna il marker e il video in base al valore dello slider
slider.addEventListener('input', function() {
    var value = slider.value;
    console.log('Slider input:', value);
    video.currentTime = value;
    updateMarker(value);
    updateTooltip(value);
});

// Aggiorna il marker in base al tempo corrente del video
video.addEventListener('timeupdate', function() {
    slider.value = video.currentTime;
    console.log('Video timeupdate:', video.currentTime);
    updateMarker(video.currentTime);
    updateTooltip(video.currentTime);
});

// Controlla il pulsante Play/Pause
playPauseButton.addEventListener('click', function() {
    if (video.paused) {
        video.play();
        playPauseButton.textContent = 'Pause';
    } else {
        video.pause();
        playPauseButton.textContent = 'Play';
    }
});

function updateMarker(time) {
    var maxTime = video.duration;
    if (maxTime === 0) return;
    var segmentCount = route.length - 1;
    var segmentTime = maxTime / segmentCount;
    var segmentIndex = Math.floor(time / segmentTime);
    if (segmentIndex >= segmentCount) {
        segmentIndex = segmentCount - 1;
    }

    var segmentStart = route[segmentIndex];
    var segmentEnd = route[segmentIndex + 1];
    var segmentElapsedTime = time - (segmentIndex * segmentTime);
    var segmentFraction = segmentElapsedTime / segmentTime;

    var lat = segmentStart.lat + (segmentEnd.lat - segmentStart.lat) * segmentFraction;
    var lng = segmentStart.lng + (segmentEnd.lng - segmentStart.lng) * segmentFraction;

    marker.setLatLng([lat, lng]);
}

function updateTooltip(time) {
    var maxTime = video.duration;
    if (maxTime === 0) return;
    var segmentCount = route.length - 1;
    var segmentTime = maxTime / segmentCount;
    var segmentIndex = Math.floor(time / segmentTime);

    altitudeChart.tooltip.setActiveElements([{
        datasetIndex: 0,
        index: segmentIndex
    }], { x: segmentIndex, y: chartData[segmentIndex] });

    altitudeChart.update();
}
</script>

</body>
</html>
